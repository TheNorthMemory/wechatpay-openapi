post:
  x-last-updated-at: 2025.08.04
  x-role:
    - 服务商
  tags:
    - 运营工具∙商品券
  summary: 退券
  description: 品牌方可以通过本接口将已经核销用户的商品券退回给用户。前置条件：已经给用户发券成功，且用户商品券当前已核销
  parameters:
    - name: openid
      in: path
      required: true
      type: string
      description: 用户OpenID
      example: oh-394z-6CGkNoJrsDLTTUKiAnp4
    - name: coupon_code
      in: path
      required: true
      type: string
      description: 用户商品券Code
      example: '123446565767'
    - name: _
      in: body
      required: true
      schema:
        type: object
        required:
          - brand_id
          - product_coupon_id
          - stock_id
          - appid
          - use_time
          - out_request_no
        properties:
          brand_id:
            type: string
            description: 品牌ID
            example: '120344'
          product_coupon_id:
            type: string
            description: 商品券ID
            example: '1000000013'
          stock_id:
            type: string
            description: 批次ID
            example: '1000000013001'
          appid:
            type: string
            description: 公众账号AppID
            example: 'wx233544546545989'
          out_request_no:
            type: string
            description: 退券请求单号
            example: '34657_20250101_123456'
          sequential_coupon_index:
            type: integer
            description: 多次优惠索引
            example: 0
  responses:
    '200':
      schema:
        type: object
        required:
          - coupon_code
          - coupon_state
          - valid_begin_time
          - valid_end_time
          - receive_time
          - send_request_no
          - send_channel
          - product_coupon
          - stock
          - brand_id
        properties:
          coupon_code:
            type: string
            description: 用户商品券Code
            example: '123446565767'
          coupon_state:
            type: string
            description: 用户商品券状态
            example: USED
            enum:
              - CONFIRMING #待确认
              - PENDING #已发放待生效
              - EFFECTIVE #已生效
              - USED #已核销
              - EXPIRED #已过期
              - DELETED #已删除
              - DEACTIVATED #已失效
          valid_begin_time:
            type: string
            format: rfc3339
            description: 有效期开始时间
            example: '2025-07-24T00:00+08:00'
          valid_end_time:
            type: string
            format: rfc3339
            description: 有效期结束时间
            example: '2025-07-24T00:00+08:00'
          receive_time:
            type: string
            format: rfc3339
            description: 领券时间
            example: '2025-07-24T00:00+08:00'
          send_request_no:
            type: string
            description: 发券请求单号
            example: MCHSEND202003101234
          send_channel:
            type: string
            description: 发券渠道
            example: API
            enum:
              - API #品牌方自主发放，品牌方调用发券接口自行发放
              - BRAND_MANAGE #摇一摇有优惠，通过摇一摇有优惠渠道发放
              - MERCHANT_CARD #名片优惠，通过名片优惠渠道发放
              - MEMBER #会员优惠，通过会员优惠渠道发放
              - SMALL_ACTIVITY #小活动，通过小活动渠道发放
          confirm_request_no:
            type: string
            description: 确认请求单号
            example: MCHCONFIRM202003101234
          confirm_time:
            type: string
            format: rfc3339
            description: 确认发放时间
            example: '2025-07-24T00:00+08:00'
          deactivate_request_no:
            type: string
            description: 失效请求单号
            example: '1002600620019090123143254436'
          deactivate_time:
            type: string
            format: rfc3339
            description: 失效时间
            example: '2025-07-24T00:00+08:00'
          deactivate_reason:
            type: string
            description: 失效原因
            example: 商品已下线
          single_usage_detail:
            type: object
            description: 单券使用详情
            properties:
              use_request_no:
                type: string
                description: 券核销请求单号
                example: '34657_20250101_123456'
              use_time:
                type: string
                format: rfc3339
                description: 核销时间
                example: '2025-07-24T00:00+08:00'
              associated_order_info:
                type: object
                description: 关联微信支付订单信息
                properties:
                  transaction_id:
                    type: string
                    description: 微信支付单号
                    example: '4200000000123456789123456789'
                  out_trade_no:
                    type: string
                    description: 商户订单号
                    example: 'trade_no_20250724123456'
                  mchid:
                    type: string
                    description: 商户号
                    example: '1234567890'
                  sub_mchid:
                    type: string
                    description: 子商户号
                    example: '1234567890'
              return_request_no:
                type: string
                description: 退券请求单号
                example: MCHRETURN202003101234
              return_time:
                type: string
                format: rfc3339
                description: 退券时间
                example: '2025-07-20T14:29:35+08:00'
          sequential_usage_detail:
            type: object
            description: 多次优惠使用详情
            properties:
              total_count:
                type: integer
                description: 总可使用次数
                example: 10
              used_count:
                type: integer
                description: 已使用次数
                example: 3
              detail_item_list:
                type: array
                description: 轮次使用详情列表
                items:
                  type: object
                  properties:
                    detail_state:
                      type: string
                      description: 轮次使用详情状态
                      example: USED
                      enum:
                        - PENDING #待生效，尚未到达可用开始时间
                        - EFFECTIVE #已生效，已到达可用开始时间
                        - USED #已核销
                        - EXPIRED #已过期，已超过有效期，不再可用
                        - DELETED #已删除，用户主动删除
                        - DEACTIVATED #已失效，品牌方主动调用失效用户商品券接口使用户商品券失效
                    valid_begin_time:
                      type: string
                      format: rfc3339
                      description: 有效期开始时间
                      example: '2025-07-20T14:29:35+08:00'
                    valid_end_time:
                      type: string
                      format: rfc3339
                      description: 有效期结束时间
                      example: '2025-07-20T14:29:35+08:00'
                    use_request_no:
                      type: string
                      description: 核销请求单号
                      example: MCHUSE202003101234
                    use_time:
                      type: string
                      format: rfc3339
                      description: 核销时间
                      example: '2025-07-20T14:29:35+08:00'
                    associated_order_info:
                      type: object
                      description: 关联微信支付订单信息
                      properties:
                        transaction_id:
                          type: string
                          description: 微信支付单号
                          example: '4200000000123456789123456789'
                        out_trade_no:
                          type: string
                          description: 商户订单号
                          example: 'trade_no_20250724123456'
                        mchid:
                          type: string
                          description: 商户号
                          example: '1234567890'
                        sub_mchid:
                          type: string
                          description: 子商户号
                          example: '1234567890'
                    return_request_no:
                      type: string
                      description: 退券请求单号
                      example: MCHRETURN202003101234
                    return_time:
                      type: string
                      format: rfc3339
                      description: 退券时间
                      example: '2025-07-20T14:29:35+08:00'
                    delete_time:
                      type: string
                      format: rfc3339
                      description: 删除时间
                      example: '2025-07-20T14:29:35+08:00'
          product_coupon:
            type: object
            description: 商品券信息
            required:
              - product_coupon_id
              - state
              - brand_id
              - scope
              - type
              - usage_mode
              - display_info
            properties:
              product_coupon_id:
                type: string
                description: 商品券ID
                example: '1000000013'
              state:
                type: string
                description: 商品券状态
                enum:
                  - AUDITING
                  - EFFECTIVE
                  - DEACTIVATED
              brand_id:
                type: string
                description: 品牌ID
                example: '120344'
              scope:
                type: string
                description: 优惠范围
                example: ALL
                enum:
                  - ALL
                  - SINGLE
              type:
                type: string
                description: 商品券类型
                example: NORMAL
                enum:
                  - NORMAL
                  - DISCOUNT
                  - EXCHANGE
              usage_mode:
                type: string
                description: 使用模式
                example: SINGLE
                enum:
                  - SINGLE
                  - SEQUENTIAL
              single_usage_info:
                type: object
                description: 单券模式信息
                properties:
                  normal_coupon:
                    type: object
                    description: 满减券使用规则
                    required:
                      - threshold
                      - discount_amount
                    properties:
                      threshold:
                        type: integer
                        description: 门槛金额
                        example: 10000
                      discount_amount:
                        type: integer
                        description: 固定减免金额
                        example: 1
                  discount_coupon:
                    type: object
                    description: 折扣券使用规则
                    required:
                      - threshold
                      - percent_off
                    properties:
                      threshold:
                        type: integer
                        description: 门槛金额
                        example: 10000
                      percent_off:
                        type: integer
                        description: 固定减免百分比
                        example: 20
              sequential_usage_info:
                type: object
                description: 多次优惠模式信息
                required:
                  - type
                  - count
                  - available_days
                properties:
                  type:
                    type: string
                    description: 多次优惠规则类型
                    example: INCREMENTAL
                    enum:
                      - INCREMENTAL
                      - EQUAL
                  count:
                    type: integer
                    description: 可使用次数
                    example: 15
                  available_days:
                    type: integer
                    description: 多次优惠有效天数
                    example: 365
                  interval_days:
                    type: integer
                    description: 多次优惠使用间隔天数
                    example: 0
              display_info:
                type: object
                description: 展示信息
                required:
                  - name
                  - image_url
                  - background_url
                properties:
                  name:
                    type: string
                    description: 商品券名称
                    example: 全场满100立打8折
                  image_url:
                    type: string
                    description: 商品券图片
                    example: https://wxpaylogo.qpic.cn/wxpaylogo/xxxxx/xxx
                  background_url:
                    type: string
                    description: 商品券背景图
                    example: https://wxpaylogo.qpic.cn/wxpaylogo/xxxxx/xxx
                  detail_image_url_list:
                    type: array
                    description: 商品券详情图列表
                    items:
                      type: string
                      example: https://wxpaylogo.qpic.cn/wxpaylogo/xxxxx/xxx
                  original_price:
                    type: integer
                    description: 商品原价
                    example: 10000
                  combo_package_list:
                    type: array
                    description: 套餐组合
                    items:
                      type: object
                      required:
                        - name
                        - pick_count
                        - choice_list
                      properties:
                        name:
                          type: string
                          description: 套餐名
                          example: 咖啡2选1
                        pick_count:
                          type: integer
                          description: 可选单品数量
                          example: 3
                        choice_list:
                          type: array
                          description: 单品列表
                          items:
                            type: object
                            required:
                              - name
                              - price
                              - count
                            properties:
                              name:
                                type: string
                                description: 单品名称
                                example: 美式
                              price:
                                type: integer
                                description: 单品价格
                                example: 10000
                              count:
                                type: integer
                                description: 单品数量
                                example: 2
                              image_url:
                                type: string
                                description: 单品图片
                                example: https://wxpaylogo.qpic.cn/wxpaylogo/xxxxx/xxx
                              mini_program_appid:
                                type: string
                                description: 单品跳转小程序AppID
                                example: wx4fd12345678
                              mini_program_path:
                                type: string
                                description: 单品跳转小程序路径
                                example: /pages/index/index
              out_product_no:
                type: string
                description: 外部商品ID
                example: Product_1234567890
              deactivate_request_no:
                type: string
                description: 失效请求单号
              deactivate_time:
                type: string
                format: rfc3339
                description: 失效时间
                example: '2025-08-31T23:59:59+08:00'
              deactivate_reason:
                type: string
                description: 失效原因
          stock:
            type: object
            description: 批次信息
            required:
              - product_coupon_id
              - stock_id
              - coupon_code_mode
              - stock_send_rule
              - usage_rule_display_info
              - coupon_display_info
              - notify_config
              - store_scope
              - sent_count_info
              - state
              - brand_id
            properties:
              product_coupon_id:
                type: string
                description: 商品券ID
                example: '1000000013'
              stock_id:
                type: string
                description: 批次ID
                example: '1000000013001'
              remark:
                type: string
                description: 备注
              coupon_code_mode:
                type: string
                description: 券Code分配模式
                example: WECHATPAY
                enum:
                  - WECHATPAY
                  - UPLOAD
                  - API_ASSIGN
              coupon_code_count_info:
                type: object
                description: 品牌方预上传的券Code数量信息
                required:
                  - total_count
                  - available_count
                properties:
                  total_count:
                    type: integer
                    description: 已上传的Code总数
                    example: 10000
                  available_count:
                    type: integer
                    description: 当前可用的Code
                    example: 999
              stock_send_rule:
                type: object
                description: 发放规则
                required:
                  - max_count
                properties:
                  max_count:
                    type: integer
                    description: 发放次数总上限
                    example: 100000
                  max_count_per_day:
                    type: integer
                    description: 每日发放次数上限
                    example: 100000000
                  max_count_per_user:
                    type: integer
                    description: 每个用户领取次数上限
                    example: 5
              single_usage_rule:
                type: object
                description: 单券使用规则
                required:
                  - coupon_available_period
                properties:
                  coupon_available_period:
                    type: object
                    description: 券可核销时间
                    required:
                      - available_begin_time
                      - available_end_time
                    properties:
                      available_begin_time:
                        type: string
                        format: rfc3339
                        description: 开始时间
                        example: '2025-08-01T00:00:00+08:00'
                      available_end_time:
                        type: string
                        format: rfc3339
                        description: 结束时间
                        example: '2025-08-31T23:59:59+08:00'
                      available_days:
                        type: integer
                        description: 生效后N天内有效
                        example: 30
                      wait_days_after_receive:
                        type: integer
                        description: 领取后N天开始生效
                        example: 1
                      weekly_available_period:
                        type: object
                        description: 每周固定可用时间
                        properties:
                          day_list:
                            type: array
                            description: 每周可用星期数
                            items:
                              type: string
                              enum:
                                - MONDAY
                                - TUESDAY
                                - WEDNESDAY
                                - THURSDAY
                                - FRIDAY
                                - SATURDAY
                                - SUNDAY
                          day_period_list:
                            type: array
                            description: 当天可用时间段
                            items:
                              type: object
                              required:
                                - begin_time
                                - end_time
                              properties:
                                begin_time:
                                  type: integer
                                  description: 当天可用开始时间
                                  example: 60
                                end_time:
                                  type: integer
                                  description: 当天可用结束时间
                                  example: 86399
                      irregular_available_period_list:
                        type: array
                        description: 无规律的可用时间段
                        items:
                          type: object
                          required:
                            - begin_time
                            - end_time
                          properties:
                            begin_time:
                              type: string
                              format: rfc3339
                              description: 开始时间
                              example: '2025-08-01T00:00:00+08:00'
                            end_time:
                              type: string
                              format: rfc3339
                              description: 结束时间
                              example: '2025-08-31T23:59:59+08:00'
                  normal_coupon:
                    type: object
                    description: 满减券使用规则
                    required:
                      - threshold
                      - discount_amount
                    properties:
                      threshold:
                        type: integer
                        description: 门槛金额
                        example: 10000
                      discount_amount:
                        type: integer
                        description: 固定减免金额
                        example: 1
                  discount_coupon:
                    type: object
                    description: 折扣券使用规则
                    required:
                      - threshold
                      - percent_off
                    properties:
                      threshold:
                        type: integer
                        description: 门槛金额
                        example: 10000
                      percent_off:
                        type: integer
                        description: 固定减免百分比
                        example: 20
                  exchange_coupon:
                    type: object
                    description: 兑换券使用规则
                    required:
                      - threshold
                      - exchange_price
                    properties:
                      threshold:
                        type: integer
                        description: 门槛金额
                        example: 10000
                      exchange_price:
                        type: integer
                        description: 固定兑换价格
                        example: 20
              sequential_usage_rule:
                type: object
                description: 多次优惠使用规则
                required:
                  - coupon_available_period
                properties:
                  coupon_available_period:
                    type: object
                    description: 券可核销时间
                    required:
                      - available_begin_time
                      - available_end_time
                    properties:
                      available_begin_time:
                        type: string
                        format: rfc3339
                        description: 开始时间
                        example: '2025-08-01T00:00:00+08:00'
                      available_end_time:
                        type: string
                        format: rfc3339
                        description: 结束时间
                        example: '2025-08-31T23:59:59+08:00'
                      wait_days_after_receive:
                        type: integer
                        description: 领取后N天开始生效
                        example: 1
                      weekly_available_period:
                        type: object
                        description: 每周固定可用时间
                        properties:
                          day_list:
                            type: array
                            description: 每周可用星期数
                            items:
                              type: string
                              enum:
                                - MONDAY
                                - TUESDAY
                                - WEDNESDAY
                                - THURSDAY
                                - FRIDAY
                                - SATURDAY
                                - SUNDAY
                          day_period_list:
                            type: array
                            description: 当天可用时间段
                            items:
                              type: object
                              required:
                                - begin_time
                                - end_time
                              properties:
                                begin_time:
                                  type: integer
                                  description: 当天可用开始时间
                                  example: 60
                                end_time:
                                  type: integer
                                  description: 当天可用结束时间
                                  example: 86399
                      irregular_available_period_list:
                        type: array
                        description: 无规律的可用时间段
                        items:
                          type: object
                          required:
                            - begin_time
                            - end_time
                          properties:
                            begin_time:
                              type: string
                              format: rfc3339
                              description: 开始时间
                              example: '2025-08-01T00:00:00+08:00'
                            end_time:
                              type: string
                              format: rfc3339
                              description: 结束时间
                              example: '2025-08-31T23:59:59+08:00'
                  normal_coupon_list:
                    type: array
                    description: 满减券使用规则
                    items:
                      type: object
                      required:
                        - threshold
                        - discount_amount
                      properties:
                        threshold:
                          type: integer
                          description: 门槛金额
                          example: 10000
                        discount_amount:
                          type: integer
                          description: 固定减免金额
                          example: 1
                  discount_coupon_list:
                    type: array
                    description: 折扣券使用规则列表
                    items:
                      type: object
                      required:
                        - threshold
                        - percent_off
                      properties:
                        threshold:
                          type: integer
                          description: 门槛金额
                          example: 10000
                        percent_off:
                          type: integer
                          description: 固定减免百分比
                          example: 20
                  exchange_coupon_list:
                    type: array
                    description: 兑换券使用规则列表
                    items:
                      type: object
                      required:
                        - threshold
                        - exchange_price
                      properties:
                        threshold:
                          type: integer
                          description: 门槛金额
                          example: 10000
                        exchange_price:
                          type: integer
                          description: 固定兑换价格
                          example: 20
                  special_first:
                    type: boolean
                    description: 多次优惠是否提供首笔特惠
              usage_rule_display_info:
                type: object
                description: 券使用规则展示信息
                required:
                  - coupon_usage_method_list
                  - usage_description
                properties:
                  coupon_usage_method_list:
                    type: array
                    description: 券使用方式列表
                    items:
                      type: string
                      enum:
                        - OFFLINE
                        - MINI_PROGRAM
                        - APP
                        - PAYMENT_CODE
                  mini_program_appid:
                    type: string
                    description: 小程序AppID
                    example: wx1234567890
                  mini_program_path:
                    type: string
                    description: 小程序跳转路径
                    example: /pages/index/product
                  app_path:
                    type: string
                    description: APP跳转路径
                  usage_description:
                    type: string
                    description: 券使用说明
                    example: 工作日可用
                  coupon_available_store_info:
                    type: object
                    description: 券可用门店信息
                    required:
                      - description
                    properties:
                      description:
                        type: string
                        description: 券可用门店描述
                        example: 所有门店可用，可使用小程序查看门店列表
                      mini_program_appid:
                        type: string
                        description: 小程序AppID
                        example: wx1234567890
                      mini_program_path:
                        type: string
                        description: 小程序跳转路径
                        example: /pages/index/product
              coupon_display_info:
                type: object
                description: 用户商品券展示信息
                properties:
                  code_display_mode:
                    type: string
                    description: 用户商品券Code展示模式
                    example: QRCODE
                    enum:
                      - INVISIBLE
                      - BARCODE
                      - QRCODE
                  background_color:
                    type: string
                    description: 背景颜色
                    example: Color020
                    enum:
                      - Color010
                      - Color020
                      - Color030
                      - Color040
                      - Color050
                      - Color060
                      - Color070
                      - Color080
                      - Color090
                      - Color100
                  entrance_mini_program:
                    type: object
                    description: 小程序入口
                    required:
                      - appid
                      - path
                      - entrance_wording
                      - guidance_wording
                    properties:
                      appid:
                        type: string
                        description: 小程序appid
                        example: wx234545656765876
                      path:
                        type: string
                        description: 小程序跳转路径
                        example: /path/index/index
                      entrance_wording:
                        type: string
                        description: 入口文案
                        example: 欢迎选购
                      guidance_wording:
                        type: string
                        description: 引导文案
                        example: 获取更多优惠
                  entrance_official_account:
                    type: object
                    description: 公众号入口
                    required:
                      - appid
                    properties:
                      appid:
                        type: string
                        description: 公众号AppID
                        example: wx1234567890
                  entrance_finder:
                    type: object
                    description: 视频号入口
                    required:
                      - finder_id
                      - finder_video_id
                      - finder_video_cover_image_url
                    properties:
                      finder_id:
                        type: string
                        description: 视频号ID
                        example: gh_12345678
                      finder_video_id:
                        type: string
                        description: 视频号视频ID
                        example: UDFsdf24df34dD456Hdf34
                      finder_video_cover_image_url:
                        type: string
                        description: 视频号封面图
                        example: https://wxpaylogo.qpic.cn/wxpaylogo/xxxxx/xxx
              notify_config:
                type: object
                description: 事件通知配置
                properties:
                  notify_appid:
                    type: string
                    description: 事件通知appid
                    example: wx23232232323
              store_scope:
                type: string
                description: 可用门店范围
                example: NONE
                enum:
                  - NONE
                  - ALL
                  - SPECIFIC
              sent_count_info:
                type: object
                description: 已发放次数
                required:
                  - total_count
                  - today_count
                properties:
                  total_count:
                    type: integer
                    description: 已发放总次数
                    example: 0
                  today_count:
                    type: integer
                    description: 当天已发放次数
                    example: 0
              state:
                type: string
                description: 批次状态
                enum:
                  - AUDITING
                  - SENDING
                  - PAUSED
                  - STOPPED
                  - DEACTIVATED
              deactivate_request_no:
                type: string
                description: 失效请求单号
              deactivate_time:
                type: string
                format: rfc3339
                description: 失效时间
                example: '2025-08-31T23:59:59+08:00'
              deactivate_reason:
                type: string
                description: 失效原因
              brand_id:
                type: string
                description: 品牌ID
                example: '120344'
          attach:
            type: string
            description: 自定义附加信息
            example: example_attach
          channel_custom_info:
            type: string
            description: 渠道自定义信息
            example: example_channel_custom_info
          brand_id:
            type: string
            description: 品牌ID
            example: '120344'
